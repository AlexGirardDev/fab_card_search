<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canadian FAB Singles search</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: auto;
            padding: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        h1, h2, h3 {
            color: #2c3e50;
            margin-top: 10px;
            margin-bottom: 5px;
        }
        .section {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        button {
            margin: 5px 5px 5px 0;
            padding: 8px 12px;
            background-color: #3498db;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #2980b9;
        }
        .store-label {
            display: block;
            margin: 0;
            padding: 8px 0;
            background-color: transparent;
            border: none;
            border-bottom: 1px solid #e8e8e8;
            cursor: move;
            user-select: none;
            transition: background-color 0.15s ease;
        }
        .store-label:hover {
            background-color: #f5f5f5;
        }
        .store-label:last-child {
            border-bottom: none;
        }
        .store-label.dragging {
            opacity: 0.6;
            background-color: #e3f2fd;
        }
        .store-label.drag-over {
            background-color: #e0f2f1;
            border-bottom: 2px solid #009688;
        }
        #card-name {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        #search-button {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            background-color: #2c3e50;
        }
        .info-box {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            color: #1565c0;
        }
        .info-box h3 {
            margin-top: 0;
            color: #1565c0;
        }
        .info-box p {
            margin: 8px 0;
            line-height: 1.5;
        }
        .info-box strong {
            color: #0d47a1;
        }
    </style>
    <script type="text/javascript">
        // Define the list of stores in a JavaScript object
        const stores = {
            GameStores: [
                { name: "Enter the Battlefield", province: "ON", url: "https://enterthebattlefield.ca/search.php?product_line=All&sort=Relevance&limit=30&name={cardName}" },
                { name: "Invasion CNC", province: "ON", url: "https://invasioncnc.ca/search.php?product_line=All&sort=Relevance&limit=30&name={cardName}&search_query={cardName}" },
                { name: "Tista", province: "ON", url: "https://tistacards.com/search?type=product&options%5Bprefix%5D=last&q={cardName}" },
                { name: "Red Dragon", province: "ON", url: "https://red-dragon.ca/search?type=product&options%5Bprefix%5D=last&q={cardName}" },
                { name: "Fantasy Forged", province: "ON", url: "https://www.fantasyforged.ca/search?type=product&options%5Bprefix%5D=last&q={cardName}"},
                { name: "mkkards", province: "ON", url: "https://mkkards.com/search?type=product&q={cardName}" },
                { name: "Duel Kingdom", province: "ON", url: "https://duelkingdom.ca/search?filter.p.product_type=Flesh+And+Blood+Single&filter.v.availability=1&options%5Bprefix%5D=last&q={cardName}" },
                { name: "Chimera Gaming Online", province: "ON", url: "https://chimeragamingonline.com/pages/mtg-advanced-search?q={cardName}&game=fleshAndBlood&availabilty=true&condition=&printing=&setNames=&rarities=&types=&pricemin=&pricemax=&page=1&order=price-descending" },
                { name: "GTGames.ca", province: "ON", url: "https://gtgames.ca/pages/advanced-search?q={cardName}&game=fleshAndBlood&availabilty=true&setNames=&rarities=&types=&pricemin=&pricemax=&page=1&order=price-descending"},
                { name: "Negative Zone Comics", province: "ON", url: "https://negativezonecomics.com/search?type=product&options%5Bprefix%5D=last&q={cardName}" },
                { name: "Tabletop Giant", province: "ON", url: "https://tabletopgiant.ca/search?type=product&options%5Bprefix%5D=last&q={cardName}" },
                { name: "VGNJ", province: "ON", url: "https://vgnj.ca/search?type=product&options%5Bprefix%5D=last&q={cardName}" },
                { name: "Le Coin Du Jeu", province: "QC", url: "https://www.lecoindujeu.ca/search?filter.p.product_type=Flesh+And+Blood+Single&filter.v.availability=1&q={cardName}" },
                { name: "Silver Goblin", province: "QC", url: "https://silvergoblin.cards/search?q={cardName}&options%5Bprefix%5D=last" },
                { name: "Cartes Léo", province: "QC", url: "https://cartesleo.ca/search?q={cardName}*" },
                { name: "Magic Stronghold", province: "BC", url: "https://www.magicstronghold.com/store/search/{cardName}" },
                { name: "Orchard City Games", province: "BC", url: "https://www.orchardcitygames.com/products/search?q={cardName}&c=13773" },
                { name: "Signarus", province: "AB", url: "https://signarus.ca/search?type=product&options%5Bprefix%5D=last&q={cardName}" },
                { name: "Exo Games", province: "PE", url: "https://exorgames.com/a/search?type=product&options%5Bprefix%5D=last&q={cardName}" }
          ],
            TCGPlayer: [
                { name: "Manta tcgplayer", province: "Online", url: "https://www.tcgplayer.com/search/flesh-and-blood-tcg/product?productLineName=flesh-and-blood-tcg&q={cardName}&view=grid" }
            ]
        };

        let draggedElement = null;

        function saveStoreState() {
            const state = {};
            for (const sectionName in stores) {
                const labels = document.querySelectorAll(`.${sectionName} .store-label`);
                state[sectionName] = {
                    checked: Array.from(labels)
                        .filter(label => label.querySelector('input[type="checkbox"]').checked)
                        .map(label => label.dataset.storeName),
                    order: Array.from(labels).map(label => label.dataset.storeName)
                };
            }
            localStorage.setItem('storeState', JSON.stringify(state));
        }

        function restoreStoreState() {
            const saved = localStorage.getItem('storeState');
            if (!saved) return;

            const state = JSON.parse(saved);
            for (const sectionName in state) {
                // Restore order first
                const checkboxGroup = document.querySelector(`.checkbox-group.${sectionName}`);
                if (checkboxGroup && state[sectionName].order) {
                    const labels = Array.from(checkboxGroup.querySelectorAll('.store-label'));
                    state[sectionName].order.forEach(storeName => {
                        const label = labels.find(l => l.dataset.storeName === storeName);
                        if (label) {
                            checkboxGroup.appendChild(label);
                        }
                    });
                }

                // Then restore checkbox state
                const labels = document.querySelectorAll(`.${sectionName} .store-label`);
                labels.forEach(label => {
                    const checkbox = label.querySelector('input[type="checkbox"]');
                    checkbox.checked = state[sectionName].checked.includes(label.dataset.storeName);
                });
            }
        }

        function setupDragAndDrop() {
            document.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('store-label')) {
                    draggedElement = e.target;
                    e.target.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                }
            });

            document.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                if (e.target.classList.contains('store-label') && e.target !== draggedElement) {
                    e.target.classList.add('drag-over');
                }
            });

            document.addEventListener('dragleave', (e) => {
                if (e.target.classList.contains('store-label')) {
                    e.target.classList.remove('drag-over');
                }
            });

            document.addEventListener('drop', (e) => {
                e.preventDefault();
                if (e.target.classList.contains('store-label') && e.target !== draggedElement) {
                    const parent = e.target.parentNode;
                    const allLabels = Array.from(parent.querySelectorAll('.store-label'));
                    const draggedIndex = allLabels.indexOf(draggedElement);
                    const targetIndex = allLabels.indexOf(e.target);

                    if (draggedIndex < targetIndex) {
                        e.target.parentNode.insertBefore(draggedElement, e.target.nextSibling);
                    } else {
                        e.target.parentNode.insertBefore(draggedElement, e.target);
                    }
                    saveStoreState();
                }
                if (draggedElement) {
                    draggedElement.classList.remove('dragging');
                }
                e.target.classList.remove('drag-over');
                draggedElement = null;
            });

            document.addEventListener('dragend', (e) => {
                if (draggedElement) {
                    draggedElement.classList.remove('dragging');
                    draggedElement = null;
                }
                document.querySelectorAll('.store-label').forEach(label => {
                    label.classList.remove('drag-over');
                });
            });
        }

        function loadStores() {
            const container = document.getElementById("store-sections");
            let isFirstSection = true;

            // Iterate over each section in the stores object
            for (const sectionName in stores) {
                if (stores.hasOwnProperty(sectionName)) {
                    // Create section container
                    const sectionDiv = document.createElement("div");
                    sectionDiv.className = "section";
                    sectionDiv.id = `${sectionName}-stores`;

                    // Add section header and buttons
                    const sectionHeader = document.createElement("h3");
                    sectionHeader.textContent = capitalizeFirstLetter(sectionName) + " Stores";

                    const selectAllButton = document.createElement("button");
                    selectAllButton.textContent = `Select All ${capitalizeFirstLetter(sectionName)}`;
                    selectAllButton.onclick = () => {
                        toggleSection(sectionName, true);
                        saveStoreState();
                    };

                    const deselectAllButton = document.createElement("button");
                    deselectAllButton.textContent = `Deselect All ${capitalizeFirstLetter(sectionName)}`;
                    deselectAllButton.onclick = () => {
                        toggleSection(sectionName, false);
                        saveStoreState();
                    };

                    sectionDiv.appendChild(sectionHeader);
                    sectionDiv.appendChild(selectAllButton);
                    sectionDiv.appendChild(deselectAllButton);

                    // Create checkbox group for stores
                    const checkboxGroup = document.createElement("div");
                    checkboxGroup.className = `checkbox-group ${sectionName}`;

                    // Add each store as a checkbox
                    stores[sectionName].forEach(store => {
                        const label = document.createElement("label");
                        label.className = "store-label";
                        label.draggable = true;
                        label.dataset.storeName = `${store.name}|${store.province}`;
                        const checkbox = document.createElement("input");
                        checkbox.type = "checkbox";
                        checkbox.value = store.url;
                        checkbox.addEventListener('change', saveStoreState);
                        // Check by default if province is ON (Ontario closest stores)
                        if (store.province === "ON") {
                            checkbox.checked = true;
                        }
                        label.appendChild(checkbox);
                        label.appendChild(document.createTextNode(` ${store.name} - ${store.province}`));
                        checkboxGroup.appendChild(label);
                    });

                    sectionDiv.appendChild(checkboxGroup);
                    container.appendChild(sectionDiv);

                    // Mark first section as processed
                    isFirstSection = false;
                }
            }

            restoreStoreState();
            setupDragAndDrop();
        }

        // Function to toggle selection for a section
        function toggleSection(section, checked) {
            const checkboxes = document.querySelectorAll(`.${section} input[type='checkbox']`);
            checkboxes.forEach(cb => cb.checked = checked);
        }

        // Function to open tabs for the selected stores
        function openTabs() {
            const cardName = document.getElementById("card-name").value;
            if (!cardName) {
                alert("Please enter a card name.");
                return;
            }

            const encodedCardName = encodeURIComponent(cardName);
            const selectedStores = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'));

            // Open in reverse order so top items open last (become active tab)
            selectedStores.reverse().forEach(store => {
                if (store.value) {
                    const searchUrl = store.value.replace('{cardName}', encodedCardName);
                    window.open(searchUrl, '_blank');
                }
            });
        }

        // Utility function to capitalize the first letter of a string
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        window.onload = function() {
            loadStores();

            // Set focus to the card name input field
            document.getElementById("card-name").focus();

            document.getElementById("card-name").addEventListener("keydown", function(event) {
                if (event.key === "Enter") {
                    openTabs();
                }
            });

            // Check for 'q' query parameter in the URL
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('q');
            if (query) {
                // Set the card name input to the query value
                document.getElementById("card-name").value = query;

                // Perform a search with the first section of stores
                openTabs();
            }
        }
    </script>
</head>
<body>
    <h1>FAB Canadian Card search</h1>

    <div class="info-box">
        <h3>⚠️ First Time Here?</h3>
        <p>This tool opens search results from multiple stores in new tabs. Your browser may block popups by default.</p>
        <p><strong>To allow this site to open tabs:</strong></p>
        <ul style="margin: 8px 0; padding-left: 20px;">
            <li>Look for a popup blocker notification at the top of your browser</li>
            <li>Click "Allow" or "Always allow popups for this site"</li>
            <li>You may need to reload the page after allowing</li>
        </ul>
        <p style="margin-bottom: 0; font-size: 0.9em; opacity: 0.8;">Once enabled, you can search across all your selected stores at once!</p>
    </div>

    <div id="store-sections">
        <!-- Store sections will be dynamically loaded here -->
    </div>
    <input type="text" id="card-name" placeholder="Enter the card name">
    <button id="search-button" onclick="openTabs()">Search Selected Stores</button>
</body>
</html>
